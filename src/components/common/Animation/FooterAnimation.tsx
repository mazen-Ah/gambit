"use client";

import { useEffect, useRef } from "react";

export default function FooterAnimation() {
  const containerRef = useRef<HTMLDivElement | null>(null);
  const sketchRef = useRef<any>(null);

  // everything we need cleaned up
  const cleanupRef = useRef<{
    p5Instance?: any;
    resizeObserver?: ResizeObserver | null;
    removeSVG?: () => void;
    removeVisibilityListener?: () => void;
    engine?: any;
    world?: any;
  } | null>(null);

  useEffect(() => {
    let mounted = true;

    async function init() {
      // dynamic imports
      const p5Module = await import("p5");
      const Matter = await import("matter-js");

      if (!mounted) return;

      const P5Constructor = p5Module.default ?? p5Module;

      const {
        Engine,
        World,
        Bodies,
        Body,
        Composite,
        Composites,
        Mouse,
        MouseConstraint,
        Runner,
      } = Matter;

      const footerEl = containerRef.current ?? document.body;

      if (footerEl.clientHeight === 0) {
        footerEl.style.minHeight = "300px";
        footerEl.style.position = "relative";
      }

      // ---- SVG path helpers ----------------------------------------------
      const SVG_PATHS = [
        "M1281.24 841.27C1276.38 838.081 1271.58 834.835 1266.75 831.588L1261.09 827.772L1259.55 826.092C1245.9 811.094 1229.6 799.257 1210.66 790.581L1210.46 790.496L1207.4 763.301C1206.97 759.172 1204.77 757.491 1203 756.779C1199.02 755.213 1193.99 757.292 1191.02 759.883C1156.28 790.097 1114.28 838.166 1111.37 895.747C1109.59 931.143 1123.23 965.031 1151.85 996.498H1148.3C1136.41 996.498 1126.75 1006.27 1126.75 1018.25C1126.75 1023.12 1128.38 1027.82 1131.29 1031.58C1127.43 1032.95 1124.63 1036.59 1124.63 1040.92V1073.3C1124.63 1078.8 1129.06 1083.24 1134.52 1083.24H1256C1261.4 1083.24 1265.81 1078.77 1265.81 1073.3V1040.92C1265.81 1036.56 1263 1032.92 1259.17 1031.55C1262.12 1027.79 1263.78 1023.1 1263.78 1018.25C1263.78 1006.27 1254.06 996.498 1242.13 996.498H1234.93C1238.36 991.856 1241.82 987.214 1245.28 982.573C1249.25 977.247 1253.2 971.922 1257.14 966.569C1260.57 961.984 1260.17 947.261 1257.69 936.412C1256.34 930.574 1253.77 923.084 1249.2 920.692C1235.42 913.545 1221.69 906.34 1207.97 899.107C1206.74 894.038 1204.8 889.14 1202.22 884.555C1205.94 883.815 1209.57 883.074 1213.14 882.334C1234.24 878.005 1252.48 874.275 1274.84 874.275C1275.73 874.275 1276.44 873.592 1276.47 872.737C1276.5 871.911 1276.58 871.057 1276.64 870.26C1276.7 869.462 1276.76 868.694 1276.81 867.953C1276.84 867.184 1276.36 866.501 1275.58 866.301C1273.53 865.76 1271.47 865.219 1269.41 864.707L1278.59 859.78C1281.96 858.015 1283.96 853.031 1284.19 849.016C1284.39 845.485 1283.3 842.751 1281.16 841.327L1281.24 841.27ZM1262.58 1040.92V1073.3C1262.58 1076.97 1259.63 1079.99 1256.03 1079.99H1134.55C1130.89 1079.99 1127.92 1077 1127.92 1073.3V1040.92C1127.92 1037.25 1130.89 1034.23 1134.55 1034.23H1256.03C1259.63 1034.23 1262.58 1037.22 1262.58 1040.92ZM1242.16 999.744C1252.28 999.744 1260.55 1008.06 1260.55 1018.25C1260.55 1023.01 1258.69 1027.59 1255.43 1030.98H1135.07C1131.86 1027.65 1130.03 1023.07 1130.03 1018.25C1130.03 1008.06 1138.24 999.744 1148.33 999.744H1242.19H1242.16ZM1277.13 856.847L1264.15 863.767C1263.55 864.08 1263.2 864.735 1263.29 865.419C1263.38 866.102 1263.86 866.643 1264.55 866.786C1267.58 867.498 1270.52 868.266 1273.5 869.035C1273.5 869.349 1273.44 869.662 1273.44 869.947C1273.44 870.288 1273.38 870.63 1273.35 870.972C1251.37 871.143 1233.33 874.845 1212.52 879.088C1208.26 879.97 1203.88 880.853 1199.36 881.736C1198.85 881.85 1198.39 882.192 1198.19 882.676C1197.96 883.16 1198.02 883.729 1198.31 884.185C1201.42 889.254 1203.68 894.75 1205 900.502C1205.11 900.958 1205.4 901.357 1205.83 901.584L1206.28 901.841C1220.06 909.102 1233.87 916.364 1247.74 923.54C1250.4 924.935 1252.88 929.862 1254.54 937.095C1257.26 948.941 1256.8 961.614 1254.54 964.604C1250.6 969.929 1246.62 975.254 1242.68 980.608C1238.73 985.904 1234.82 991.201 1230.9 996.498H1156.25C1126.86 965.059 1112.88 931.229 1114.65 895.917C1117.48 839.476 1158.91 792.148 1193.16 762.361C1195.85 760.054 1199.56 758.944 1201.79 759.826C1203.17 760.368 1203.94 761.649 1204.17 763.671L1207.34 791.806C1207.4 792.376 1207.77 792.86 1208.28 793.116L1209.34 793.6C1227.87 802.086 1243.8 813.667 1257.14 828.342L1258.8 830.164C1258.8 830.164 1259 830.335 1259.09 830.421L1264.92 834.35C1269.75 837.597 1274.58 840.843 1279.44 844.061C1280.56 844.801 1281.13 846.567 1281.02 848.874C1280.82 852.319 1279.1 855.907 1277.16 856.933L1277.13 856.847Z",
        "M1267.83 1679.01C1270.93 1677.08 1273 1673.66 1273 1669.77C1273 1664.17 1268.8 1659.56 1263.43 1658.9C1239.67 1629.1 1230.02 1604.59 1228.17 1569.38H1239.42C1242.71 1569.38 1245.39 1566.45 1245.39 1562.87V1554.65C1245.39 1551.06 1242.71 1548.14 1239.42 1548.14H1221.41C1233.54 1542.16 1241.61 1529.65 1241.61 1515.4C1241.61 1495.32 1225.41 1479 1205.53 1479H1189.5C1169.64 1479 1153.48 1495.32 1153.48 1515.4C1153.48 1529.65 1161.55 1542.13 1173.79 1548.14H1155.67C1152.31 1548.14 1149.61 1551.06 1149.61 1554.65V1562.87C1149.61 1566.45 1152.34 1569.38 1155.67 1569.38H1166.92C1165.1 1604.53 1155.41 1629.02 1131.57 1658.9C1126.18 1659.56 1122 1664.17 1122 1669.77C1122 1673.66 1124.07 1677.08 1127.17 1679.01C1124.19 1680.86 1122.17 1684.19 1122.17 1688V1701.42C1122.17 1707.25 1126.83 1712 1132.57 1712H1262.46C1268.26 1712 1272.94 1707.25 1272.94 1701.42V1688C1272.94 1684.24 1270.87 1680.89 1267.83 1679.01ZM1156.72 1515.37C1156.72 1497.09 1171.41 1482.24 1189.47 1482.24H1205.5C1223.59 1482.24 1238.34 1497.12 1238.34 1515.37C1238.34 1531.64 1226.81 1545.43 1211.21 1548.11H1183.99C1168.17 1545.35 1156.72 1531.61 1156.72 1515.37ZM1152.85 1562.84V1554.62C1152.85 1552.86 1154.13 1551.35 1155.67 1551.35H1239.42C1240.92 1551.35 1242.15 1552.8 1242.15 1554.62V1562.84C1242.15 1564.63 1240.92 1566.08 1239.42 1566.08H1155.67C1154.13 1566.08 1152.85 1564.6 1152.85 1562.84ZM1170.16 1569.38H1224.87C1226.66 1604.16 1236.41 1629.61 1259.14 1658.79H1135.81C1158.62 1629.56 1168.37 1604.1 1170.16 1569.38ZM1132.85 1662.03H1262.12C1266.32 1662.03 1269.76 1665.5 1269.76 1669.77C1269.76 1674.03 1266.32 1677.42 1262.12 1677.42H1132.85C1128.65 1677.42 1125.21 1673.98 1125.21 1669.77C1125.21 1665.56 1128.65 1662.03 1132.85 1662.03ZM1269.68 1701.42C1269.68 1705.46 1266.44 1708.76 1262.43 1708.76H1132.54C1128.59 1708.76 1125.38 1705.46 1125.38 1701.42V1688C1125.38 1683.96 1128.59 1680.66 1132.54 1680.66H1262.43C1266.35 1680.66 1269.68 1684.02 1269.68 1688V1701.42Z",
        "M768.933 1761.65C772.639 1757.09 774.663 1751.45 774.663 1745.44C774.663 1732.17 764.601 1721.21 751.746 1719.9C728.287 1682.7 727.974 1652.25 727.974 1606.82H737.808C741.656 1606.82 744.762 1603.69 744.762 1599.82V1590.59C744.762 1586.97 741.998 1584.01 738.492 1583.64L731.052 1576.97C733.219 1575.78 734.729 1573.44 734.729 1570.77V1561.62C734.729 1558.03 732.107 1555.1 728.715 1554.62L723.014 1545.82C723.242 1511.98 731.081 1481.05 746.33 1453.88C748.838 1453.39 750.72 1451.17 750.72 1448.52V1436.79C750.72 1433.77 748.297 1431.32 745.304 1431.32H740.857C732.791 1424.6 718.539 1420.04 702.207 1418.79C703.489 1411.98 705.998 1408.99 708.42 1406.11C711.413 1402.61 714.264 1399.28 714.264 1390.36C714.264 1378.57 704.772 1369 693.085 1369C681.399 1369 671.822 1378.6 671.822 1390.36C671.822 1399.28 674.815 1402.75 677.694 1406.11C680.145 1408.96 682.682 1411.95 683.964 1418.79C667.66 1420.04 653.409 1424.6 645.342 1431.32H640.81C637.874 1431.32 635.394 1433.82 635.394 1436.79V1448.52C635.394 1451.14 637.333 1453.39 639.784 1453.88C655.005 1480.91 662.843 1511.84 663.1 1545.82L657.485 1554.62C654.064 1555.1 651.385 1558.03 651.385 1561.62V1570.77C651.385 1573.47 652.924 1575.81 655.119 1577L647.708 1583.64C644.145 1583.98 641.352 1586.94 641.352 1590.59V1599.82C641.352 1603.69 644.515 1606.82 648.392 1606.82H658.226C658.226 1652.25 657.912 1682.7 634.454 1719.9C621.599 1721.18 611.508 1732.14 611.508 1745.44C611.508 1751.43 613.504 1757.06 617.181 1761.65C612.449 1763.1 609 1767.46 609 1772.67V1811.41C609 1817.79 614.159 1823 620.487 1823H765.513C771.841 1823 777 1817.82 777 1811.41V1772.67C777 1767.46 773.551 1763.1 768.848 1761.65H768.933ZM680.23 1404C677.38 1400.7 675.128 1398.08 675.128 1390.39C675.128 1380.42 683.195 1372.28 693.143 1372.28C703.09 1372.28 711.071 1380.39 711.071 1390.39C711.071 1398.11 708.848 1400.7 705.998 1404.03C703.347 1407.14 700.354 1410.61 698.957 1418.62C697.047 1418.53 695.109 1418.47 693.143 1418.47C691.176 1418.47 689.238 1418.53 687.328 1418.62C685.903 1410.61 682.91 1407.14 680.23 1404.03V1404ZM685.988 1421.95C685.988 1421.95 686.017 1421.95 686.045 1421.95C690.634 1421.63 695.622 1421.63 700.211 1421.95C700.24 1421.95 700.297 1421.95 700.325 1421.95C714.492 1422.8 727.119 1426.19 735.328 1431.32H650.9C659.138 1426.16 671.793 1422.8 685.988 1421.92V1421.95ZM638.701 1436.79C638.701 1435.62 639.727 1434.59 640.867 1434.59H745.333C746.53 1434.59 747.499 1435.59 747.499 1436.79V1448.52C747.499 1449.75 746.53 1450.71 745.333 1450.71H640.867C639.727 1450.71 638.701 1449.69 638.701 1448.52V1436.79ZM742.568 1453.99C727.86 1480.93 720.192 1511.41 719.822 1544.68H666.406C666.007 1511.3 658.368 1480.82 643.66 1453.99H742.568ZM665.665 1547.92H720.534L724.81 1554.53H661.475L665.694 1547.92H665.665ZM654.691 1561.62C654.691 1559.51 656.401 1557.78 658.482 1557.78H727.803C729.884 1557.78 731.508 1559.46 731.508 1561.62V1570.77C731.508 1572.9 729.884 1574.61 727.803 1574.61H658.482C656.401 1574.61 654.691 1572.9 654.691 1570.77V1561.62ZM659.109 1577.86H727.176L733.561 1583.55H652.724L659.109 1577.86ZM644.686 1599.79V1590.56C644.686 1588.48 646.397 1586.8 648.477 1586.8H737.836C739.831 1586.8 741.542 1588.51 741.542 1590.56V1599.79C741.542 1601.81 739.86 1603.55 737.836 1603.55H648.477C646.397 1603.55 644.686 1601.87 644.686 1599.79ZM661.561 1606.82H724.724C724.724 1652.08 725.009 1682.61 747.812 1719.75H638.473C661.276 1682.61 661.561 1652.05 661.561 1606.82ZM637.076 1723H749.152C761.437 1723 771.442 1733.05 771.442 1745.42C771.442 1751.34 769.19 1756.87 765.114 1761.08H621.114C617.095 1756.84 614.872 1751.31 614.872 1745.42C614.872 1733.05 624.848 1723 637.076 1723ZM773.836 1811.41C773.836 1815.99 770.159 1819.72 765.599 1819.72H620.572C616.04 1819.72 612.335 1815.99 612.335 1811.41V1772.67C612.335 1768.09 616.012 1764.36 620.572 1764.36H765.599C770.131 1764.36 773.836 1768.09 773.836 1772.67V1811.41Z",
        "M609.212 903.541C612.539 899.308 614.359 894.109 614.359 888.655C614.359 876.269 604.975 866.071 593.004 864.878C571.364 830.249 571.051 793.745 571.051 751.616H580.065C583.734 751.616 586.691 748.662 586.691 745.026V736.475C586.691 733.095 584.103 730.311 580.776 729.97L574.065 723.89C576.056 722.754 577.449 720.624 577.449 718.181V709.63C577.449 706.278 574.975 703.522 571.79 703.068L566.757 695.199C567.724 692.415 569.004 688.977 570.511 685C581.089 657.019 598.748 610.231 575.174 598.3C574.151 589.125 562.862 581.767 547.478 579.693L559.364 551.911C559.563 551.484 559.535 550.973 559.335 550.547L539.572 510.521C539.572 510.521 539.516 510.464 539.487 510.435C539.43 510.322 539.345 510.208 539.26 510.094C539.203 510.038 539.117 510.009 539.061 509.952C539.004 509.896 538.918 509.867 538.862 509.81C538.833 509.81 538.776 509.754 538.748 509.725C538.577 509.668 538.407 509.64 538.236 509.612C538.208 509.612 538.151 509.583 538.122 509.583C538.094 509.583 538.037 509.612 538.008 509.612C537.838 509.612 537.667 509.64 537.497 509.725C537.468 509.725 537.44 509.782 537.383 509.782C537.298 509.81 537.241 509.867 537.155 509.924C537.099 509.981 537.013 510.009 536.956 510.066C536.871 510.18 536.786 510.293 536.729 510.435C536.729 510.435 536.672 510.464 536.672 510.492L516.852 550.519C516.625 550.945 516.625 551.456 516.824 551.882L528.852 579.807C514.037 582.051 503.231 589.295 502.236 598.243C478.805 610.146 496.321 656.763 506.814 684.66C508.35 688.75 509.686 692.301 510.653 695.142L505.62 703.011C502.463 703.494 500.018 706.249 500.018 709.573V718.124C500.018 720.624 501.326 722.697 503.317 723.834L496.606 729.913C493.335 730.282 490.776 733.038 490.776 736.418V744.969C490.776 748.605 493.705 751.56 497.317 751.56H506.331C506.331 793.688 506.018 830.192 484.378 864.821C472.407 866.071 463.051 876.241 463.051 888.598C463.051 894.081 464.871 899.251 468.226 903.512C463.933 904.932 460.805 908.995 460.805 913.824V949.76C460.805 955.725 465.61 960.583 471.553 960.583H605.999C611.971 960.583 616.805 955.725 616.805 949.76V913.824C616.805 908.995 613.648 904.932 609.298 903.512L609.212 903.541ZM520.065 551.342L538.094 514.952L556.065 551.342L544.065 579.352C542.302 579.21 540.511 579.125 538.663 579.125C536.445 579.125 534.283 579.239 532.179 579.466L520.065 551.371V551.342ZM531.099 582.818H531.155H545.032C545.174 582.818 545.288 582.733 545.43 582.704C559.591 584.238 570.511 590.431 571.876 598.045H505.449C506.786 590.573 517.335 584.494 531.099 582.818ZM503.43 601.311H573.895C594.539 612.163 576.937 658.752 567.44 683.864C565.99 687.671 564.738 691.023 563.771 693.778H513.554C512.587 690.966 511.279 687.5 509.8 683.58C500.388 658.553 482.928 612.135 503.43 601.311ZM513.269 697.017H564.056L567.866 702.954H509.487L513.298 697.017H513.269ZM503.203 709.63C503.203 707.755 504.681 706.221 506.501 706.221H570.824C572.644 706.221 574.208 707.783 574.208 709.63V718.181C574.208 720.027 572.7 721.504 570.824 721.504H506.501C504.653 721.504 503.203 720.027 503.203 718.181V709.63ZM507.127 724.771H570.198L575.857 729.885H501.44L507.099 724.771H507.127ZM493.933 745.026V736.475C493.933 734.6 495.383 733.151 497.231 733.151H580.094C581.942 733.151 583.478 734.657 583.478 736.475V745.026C583.478 746.872 581.971 748.349 580.094 748.349H497.231C495.383 748.349 493.933 746.872 493.933 745.026ZM509.487 751.616H567.809C567.809 793.489 568.094 829.908 589.08 864.736H488.189C509.203 829.908 509.459 793.489 509.459 751.616H509.487ZM486.738 868.003H590.644C601.933 868.003 611.089 877.263 611.089 888.655C611.089 894.024 609.07 899.081 605.43 902.972H471.866C468.198 899.081 466.208 894.024 466.208 888.655C466.208 877.263 475.421 868.003 486.738 868.003ZM613.449 949.817C613.449 953.993 610.065 957.373 605.885 957.373H471.44C467.317 957.373 463.961 953.964 463.961 949.817V913.881C463.961 909.677 467.317 906.239 471.44 906.239H605.544C605.715 906.296 605.885 906.324 606.056 906.324C606.141 906.324 606.198 906.296 606.283 906.296C610.264 906.495 613.478 909.819 613.478 913.909V949.845L613.449 949.817Z",
        "M167.929 1700.16C171.807 1695.4 173.974 1689.39 173.974 1683.23C173.974 1669.2 163.338 1657.65 149.793 1656.42L122.903 1515.68C125.783 1511.32 130.345 1507.76 136.904 1504.79H140.411C143.32 1504.79 145.687 1502.4 145.687 1499.49V1489.11C145.687 1487.68 145.116 1486.4 144.204 1485.43C145.116 1484.49 145.687 1483.18 145.687 1481.75V1431.31C145.687 1429.2 143.976 1427.46 141.866 1427.46H124.015C121.961 1427.46 120.279 1429.17 120.279 1431.31V1447.39H101.316V1431.31C101.316 1429.2 99.605 1427.46 97.4948 1427.46H79.6439C77.5907 1427.46 75.9083 1429.17 75.9083 1431.31V1447.39H56.9453V1431.31C56.9453 1429.2 55.2343 1427.46 53.1241 1427.46H35.2732C33.22 1427.46 31.5376 1429.17 31.5376 1431.31L31.5376 1481.75C31.5376 1483.18 32.1079 1484.46 32.9919 1485.43C32.0794 1486.37 31.5376 1487.68 31.5376 1489.11V1499.49C31.5376 1502.42 33.8759 1504.79 36.7275 1504.79H40.2349C46.7365 1507.7 51.3276 1511.26 54.2362 1515.68L27.4313 1656.42C13.8577 1657.68 3.16425 1669.23 3.16425 1683.23C3.16425 1689.39 5.36 1695.43 9.20965 1700.16C4.24788 1701.65 0.569336 1706.21 0.569336 1711.71L0.569336 1752.37C0.569336 1759.04 5.93031 1764.46 12.546 1764.46H164.593C171.208 1764.46 176.569 1759.04 176.569 1752.37V1711.71C176.569 1706.24 172.919 1701.65 167.929 1700.16ZM34.7884 1431.28C34.7884 1430.97 35.045 1430.71 35.2446 1430.71H53.0956C53.4093 1430.71 53.6374 1430.97 53.6374 1431.28V1448.99C53.6374 1449.9 54.3788 1450.62 55.2628 1450.62H77.4766C78.3891 1450.62 79.1021 1449.87 79.1021 1448.99V1431.28C79.1021 1430.97 79.3587 1430.71 79.5869 1430.71H97.4378C97.7514 1430.71 97.9796 1430.97 97.9796 1431.28V1448.99C97.9796 1449.9 98.721 1450.62 99.605 1450.62H121.819C122.731 1450.62 123.444 1449.87 123.444 1448.99V1431.28C123.444 1430.97 123.701 1430.71 123.929 1430.71H141.78C142.094 1430.71 142.322 1430.97 142.322 1431.28V1481.72C142.322 1482.86 141.438 1483.78 140.326 1483.78H36.6134C35.5583 1483.78 34.7029 1482.86 34.7029 1481.72V1431.28H34.7884ZM34.7884 1499.46L34.7884 1489.08C34.7884 1487.97 35.6439 1487.03 36.699 1487.03H140.411C141.523 1487.03 142.407 1487.91 142.407 1489.08V1499.46C142.407 1500.6 141.523 1501.51 140.411 1501.51H36.699C35.6439 1501.51 34.7884 1500.6 34.7884 1499.46ZM47.2783 1504.76H129.889C125.726 1507.33 122.56 1510.27 120.279 1513.66H56.8312C54.5499 1510.24 51.3846 1507.3 47.2498 1504.76H47.2783ZM57.2874 1516.94H119.823L146.428 1656.28H30.7391L57.2874 1516.94ZM29.8266 1659.56H147.369C160.23 1659.56 170.724 1670.17 170.724 1683.23C170.724 1689.33 168.3 1695.26 164.079 1699.65H13.0593C8.83891 1695.29 6.41506 1689.33 6.41506 1683.23C6.41506 1670.17 16.9374 1659.56 29.8551 1659.56H29.8266ZM173.29 1752.37C173.29 1757.25 169.383 1761.18 164.564 1761.18H12.5175C7.78382 1761.18 3.7916 1757.13 3.7916 1752.37L3.7916 1711.71C3.7916 1706.92 7.78382 1702.9 12.5175 1702.9H164.564C169.383 1702.9 173.29 1706.87 173.29 1711.71V1752.37Z",
        "M157.754 296.389C161.047 292.248 162.823 287.221 162.823 281.937C162.823 269.884 153.715 259.916 142.058 258.687C123.069 228.783 115.364 204.134 113.875 168.688H125.962C129.341 168.688 131.976 165.86 131.976 162.233V153.979C131.976 150.637 129.657 147.923 126.706 147.524L120.749 141.697C122.553 140.554 123.785 138.469 123.785 136.07V127.816C123.785 124.674 121.522 121.96 118.63 121.475L113.531 115.048C140.426 88.8854 125.847 64.0649 111.727 40.0441C105.054 28.705 98.1509 16.9659 96.146 5.48394C95.5159 2.25642 92.5086 0 88.8425 0C88.8138 0 88.7852 0 88.7279 0C85.2337 0.0285622 82.5127 2.19929 81.9685 5.36969C79.9923 16.8517 73.061 28.6478 66.3589 40.0441C52.2387 64.0649 37.6602 88.8854 64.5259 114.991L59.3991 121.475C56.535 121.96 54.3296 124.617 54.3296 127.844V136.099C54.3296 138.498 55.5325 140.554 57.3083 141.697L51.3222 147.552C48.3435 147.952 46.0522 150.694 46.0522 154.007V162.262C46.0522 165.889 48.6872 168.717 52.0669 168.717H64.2395C62.7788 204.019 55.0456 228.669 36.0563 258.716C24.342 259.916 15.1767 269.884 15.1767 281.994C15.1767 287.278 16.9811 292.305 20.2749 296.475C16.0646 297.875 13 301.788 13 306.443V341.375C13 347.23 17.7545 352 23.5687 352H154.517C160.303 352 165 347.23 165 341.375V306.443C165 301.759 161.935 297.818 157.725 296.447L157.754 296.389ZM69.1945 41.6436C76.0398 29.9903 83.1142 17.9656 85.205 5.88381C85.5487 3.97014 87.2672 3.25609 88.7852 3.22753H88.8425C90.561 3.22753 92.5658 4.11295 92.9382 6.02662C95.029 18.0513 102.103 30.0474 108.92 41.6436C123.126 65.8072 136.559 88.6284 110.725 113.22H67.4473C41.5555 88.6569 54.9883 65.8072 69.2231 41.6436H69.1945ZM67.476 116.505H110.553L114.362 121.332H63.638L67.4473 116.505H67.476ZM57.5947 127.787C57.5947 126.073 58.8549 124.588 60.3443 124.588H117.656C119.202 124.588 120.491 126.045 120.491 127.787V136.042C120.491 137.812 119.202 139.298 117.656 139.298H60.3443C58.8263 139.298 57.5947 137.841 57.5947 136.042V127.787ZM61.0316 142.582H116.997L121.923 147.409H56.0767L61.003 142.582H61.0316ZM49.3173 162.204V153.95C49.3173 152.151 50.5489 150.665 52.0669 150.665H125.933C127.451 150.665 128.683 152.122 128.683 153.95V162.204C128.683 164.004 127.48 165.403 125.933 165.403H52.0669C50.5203 165.403 49.3173 164.004 49.3173 162.204ZM67.5332 168.66H110.581C112.013 203.62 119.832 229.211 138.106 258.516H40.0375C58.3107 229.068 66.1298 203.505 67.5619 168.66H67.5332ZM38.4336 261.801H139.595C150.593 261.801 159.558 270.826 159.558 281.908C159.558 287.078 157.553 291.991 153.944 295.818H24.1128C20.4754 291.991 18.4991 287.078 18.4991 281.908C18.4991 270.826 27.4639 261.801 38.4622 261.801H38.4336ZM161.735 341.289C161.735 345.345 158.498 348.658 154.517 348.658H23.5687C19.5589 348.658 16.2651 345.345 16.2651 341.289V306.358C16.2651 302.359 19.5303 299.074 23.5687 299.074H154.517C158.498 299.074 161.735 302.33 161.735 306.358V341.289Z",
      ];

      function ensureScratchSVG(): SVGSVGElement {
        let s = footerEl.querySelector("#scratch") as SVGSVGElement | null;
        if (!s) {
          s = document.createElementNS("http://www.w3.org/2000/svg", "svg");
          s.setAttribute("id", "scratch");
          s.setAttribute("width", "0");
          s.setAttribute("height", "0");
          s.style.position = "absolute";
          s.style.left = "-9999px";
          s.style.top = "-9999px";
          footerEl.appendChild(s);
        }
        return s;
      }

      function getPathBBox(d: string): DOMRect {
        const svg = ensureScratchSVG();
        const pth = document.createElementNS("http://www.w3.org/2000/svg", "path");
        pth.setAttribute("d", d);
        svg.appendChild(pth);
        const bb = pth.getBBox();
        svg.removeChild(pth);
        return bb;
      }

      function splitSubpaths(d: string): string[] {
        const parts: string[] = [];
        const re = /[Mm][^Mm]*/g;
        let m: RegExpExecArray | null;
        while ((m = re.exec(d)) !== null) parts.push(m[0].trim());
        return parts.length ? parts : [d];
      }

      const PATH_INFO = SVG_PATHS.map((d) => {
        const bbox = getPathBBox(d);
        const subDs = splitSubpaths(d);
        return {
          d,
          bbox,
          outerD: subDs[0],
          hasHoles: subDs.length > 1,
        };
      });

      // ---- Physics constants ---------------------------------------------
      const CIRCLE_RADIUS = 60;
      const MOUSE_FORCE_RADIUS = 180;
      const MOUSE_FORCE_GAIN = 0.01;
      const STROKE_PX = 0.4;

      let engine: any = null;
      let world: any = null;
      let bodies: any[] = [];
      let mouseConstraint: any = null;
      let walls: any = null;

      let pointerPos = { x: 0, y: 0 };
      let prevPointer: { x: number; y: number } | null = null;
      let pointerVel = { x: 0, y: 0 };

      const isTouchLike =
        (typeof window !== "undefined" &&
          window.matchMedia?.("(pointer: coarse)").matches) ||
        "ontouchstart" in window;

      function makeWalls(w: number, h: number) {
        const params = { isStatic: true };
        const ground = Bodies.rectangle(w / 2, h + 0.5, w, 1, params);
        const top = Bodies.rectangle(w / 2, -0.5, w, 1, params);
        const left = Bodies.rectangle(-0.5, h / 2, 1, h, params);
        const right = Bodies.rectangle(w + 0.5, h / 2, 1, h, params);
        return Body.create({ parts: [ground, left, right, top], isStatic: true });
      }

      function rebuildWalls(p: any) {
        if (world && walls) {
          World.remove(world, walls);
        }
        walls = makeWalls(p.width, p.height);
        if (world) {
          World.add(world, walls);
          
          // Keep bodies within new bounds
          for (const b of bodies) {
            if (b.position.x < 0) Body.setPosition(b, { x: CIRCLE_RADIUS, y: b.position.y });
            if (b.position.x > p.width) Body.setPosition(b, { x: p.width - CIRCLE_RADIUS, y: b.position.y });
            if (b.position.y < 0) Body.setPosition(b, { x: b.position.x, y: CIRCLE_RADIUS });
            if (b.position.y > p.height) Body.setPosition(b, { x: b.position.x, y: p.height - CIRCLE_RADIUS });
          }
        }
      }

      function getFooterSize() {
        const r = footerEl.getBoundingClientRect();
        return {
          w: Math.max(1, Math.floor(r.width)),
          h: Math.max(1, Math.floor(r.height)),
        };
      }

      function applyPointerForces(cx: number, cy: number) {
        const speed = Math.hypot(pointerVel.x, pointerVel.y);
        if (speed < 0.01) return;

        const r2 = MOUSE_FORCE_RADIUS * MOUSE_FORCE_RADIUS;
        for (const b of bodies) {
          const dx = b.position.x - cx;
          const dy = b.position.y - cy;
          const d2 = dx * dx + dy * dy;
          if (d2 > r2) continue;

          const d = Math.sqrt(d2) || 0.001;
          const nx = dx / d;
          const ny = dy / d;
          const falloff = 1 - d / MOUSE_FORCE_RADIUS;
          const mag = speed * falloff * MOUSE_FORCE_GAIN;

          Body.applyForce(b, b.position, { x: nx * mag, y: ny * mag });
        }
      }

      // ---- p5 sketch ------------------------------------------------------
      const sketch = (p: any) => {
        let physicsPaused = false;

        p.setup = () => {
          const eng = Engine.create();
          engine = eng;
          world = eng.world;
          world.gravity.y = 0.2;

          const { w, h } = getFooterSize();
          const cnv = p.createCanvas(w, h);
          cnv.parent(footerEl);

          // pointer tracking
          window.addEventListener(
            "pointermove",
            (e) => {
              const rect = cnv.elt.getBoundingClientRect();
              pointerPos.x = e.clientX - rect.left;
              pointerPos.y = e.clientY - rect.top;
            },
            { passive: true }
          );

          if (isTouchLike) {
            const mouse = Mouse.create(cnv.elt as HTMLElement);
            mouse.pixelRatio = p.pixelDensity();
            mouseConstraint = MouseConstraint.create(eng, {
              mouse,
              constraint: { stiffness: 0.1 },
            });
            World.add(world, mouseConstraint);
          }

          rebuildWalls(p);

          const makeCircle = (x: number, y: number) =>
            Bodies.circle(x, y, CIRCLE_RADIUS, {
              restitution: 0.25,
              friction: 0.2,
            });

          const cols = Math.max(4, Math.floor(p.width / 240));
          const rows = Math.max(4, Math.floor(p.height / 240));

          const stack = Composites.stack(40, 40, cols, rows, 24, 16, makeCircle);
          bodies = stack.bodies;
          World.add(world, stack);

          // Ensure all bodies are within bounds
          for (const b of bodies) {
            if (b.position.x < CIRCLE_RADIUS)
              Body.setPosition(b, { x: CIRCLE_RADIUS, y: b.position.y });
            if (b.position.x > p.width - CIRCLE_RADIUS)
              Body.setPosition(b, { x: p.width - CIRCLE_RADIUS, y: b.position.y });
          }

          pointerPos = { x: p.mouseX, y: p.mouseY };
          prevPointer = { ...pointerPos };

          const ro = new ResizeObserver(() => {
            const { w: nw, h: nh } = getFooterSize();
            if (nw !== p.width || nh !== p.height) {
              p.resizeCanvas(nw, nh, true);
              rebuildWalls(p);
            }
          });
          ro.observe(footerEl);

          // Pause physics when tab is hidden to prevent issues
          const handleVisibilityChange = () => {
            physicsPaused = document.hidden;
          };

          document.addEventListener("visibilitychange", handleVisibilityChange);

          cleanupRef.current = {
            ...cleanupRef.current,
            resizeObserver: ro,
            removeVisibilityListener: () => {
              document.removeEventListener(
                "visibilitychange",
                handleVisibilityChange
              );
            },
          };
        };

        p.draw = () => {
          if (!engine || !world) return;

          p.clear();

          // Cap deltaTime to prevent physics explosion when returning from inactive tab
          if (!physicsPaused) {
            const safeDelta = Math.min(p.deltaTime, 33); // Max ~30fps worth of time
            Engine.update(engine, safeDelta);
          }

          p.background(0, 0); // Transparent background instead of clear()

          const px = pointerPos.x;
          const py = pointerPos.y;

          if (prevPointer) {
            pointerVel.x = px - prevPointer.x;
            pointerVel.y = py - prevPointer.y;
          }
          prevPointer = { x: px, y: py };

          applyPointerForces(px, py);

          const ctx = p.drawingContext as CanvasRenderingContext2D;
          const dpr = window.devicePixelRatio || 1;

          for (let i = 0; i < bodies.length; i++) {
            const b = bodies[i];
            const r = (b as any).circleRadius;
            const { d, bbox, outerD, hasHoles } = PATH_INFO[i % PATH_INFO.length];

            p.push();
            p.translate(b.position.x, b.position.y);
            p.rotate(b.angle);
            p.translate(-r, -r);

            const pad = 3;
            const box = r * 2;
            const sx = (box - 2 * pad) / bbox.width;
            const sy = (box - 2 * pad) / bbox.height;
            const s = Math.min(sx, sy);

            ctx.save();
            ctx.translate(pad - bbox.x * s, pad - bbox.y * s);
            ctx.scale(s, s);

            ctx.lineWidth = (STROKE_PX * dpr) / s;
            ctx.fillStyle = "#CF0F69";
            ctx.strokeStyle = "rgba(255,255,255,0.4)";

            const fullPath = new Path2D(d);
            ctx.fill(fullPath, "evenodd");
            ctx.stroke(hasHoles ? new Path2D(outerD) : fullPath);

            ctx.restore();
            p.pop();
          }
        };

        p.windowResized = () => {
          const { w, h } = getFooterSize();
          if (w !== p.width || h !== p.height) {
            p.resizeCanvas(w, h, true);
            rebuildWalls(p);
          }
        };
      };

      // create p5 instance
      const instance = new (P5Constructor as any)(sketch);
      sketchRef.current = instance;

      cleanupRef.current = {
        p5Instance: instance,
        resizeObserver: cleanupRef.current?.resizeObserver ?? null,
        removeSVG: () => {
          const s = footerEl.querySelector("#scratch");
          s?.remove();
        },
        engine: engine,
        world: world,
      };
    }

    init();

    return () => {
      mounted = false;
      const clean = cleanupRef.current;

      try {
        clean?.p5Instance?.remove();
      } catch {}

      try {
        clean?.resizeObserver?.disconnect();
      } catch {}

      try {
        clean?.removeSVG?.();
      } catch {}
      
      try {
        clean?.removeVisibilityListener?.();
      } catch {}

      if (clean?.engine) {
        try {
          clean.engine.events = {};
        } catch {}
      }
    };
  }, []);

  return (
    <div ref={containerRef} className="absolute inset-0">
    </div>
  );
}